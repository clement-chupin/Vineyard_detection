<launch>

  <!-- URBAN DRIVE -->
  <!-- <arg name="bag" default="/media/chupin/partition_deux/kitti_dataset/kitti_2011_09_26_drive_0001_synced.bag"/> -->
  <!-- <arg name="bag" default="/mnt/partition_deux/demo_viti.bag"/> -->
  <!-- <arg name="bag" default="/mnt/partition_deux/113_ref_summer_vine.bag"/> -->
  <arg name="bag" default="/mnt/partition_deux/bag_files/bag_2021-11-09-12-48-25.bag"/>

  
  <!-- /alpo_driver/ackermann_controller/odom -->


<!-- For frame [follower/base_footprint]: No transform to fixed frame [base_link].  TF error: [Could not find a connection between 'base_link' and 'follower/base_footprint' because they are not part of the same tree.Tf has two or more unconnected trees.]     -->
<!-- For frame [follower/base_footprint]: 
No transform to fixed frame [base_link].  
TF error: 
[Could not find a connection between 'base_link' and 'follower/base_footprint' 
because they are not part of the same tree.Tf has two or more unconnected trees.] -->
<!-- #For frame [follower/base_footprint]: Frame [follower/base_footprint] does not exist -->

 <node name="static_tf_lidar1" pkg="tf2_ros" type="static_transform_publisher"
    args="0.1 0.0 1.81  0.0 0.5 0.0 base_link lidar_link"/>

<!-- <node name="static_tf_lidar2" pkg="tf2_ros" type="static_transform_publisher"
    args="0.0 0.0 0.0  0 0 0 base_link follower/base_footprint"/>  -->


<node pkg="reconstruction_3d" type="reconstruction_3d_node" name="lidar_cloud"
    required="true" output="screen">
    <remap from="~scan" to="/lidar/scan"/>
    <remap from="~odom" to="/alpo_driver/ackermann_controller/odom"/>

    <!-- <remap from="~map" to="/lidar_cloud/map"/>
    <remap from="~area" to="/lidar_cloud/area"/> -->
    <rosparam>
      update_freq: 10         # frequency of the publication timer
      scan_queue_size: 200     # maximal number of lidar scan used in the generated point cloud
      lidar_angle_limit: 40  # angle around the center of the scan (affect the width of the point cloud)
      robot_frame: "base_link"
    </rosparam>
  </node>



  <node pkg="big_pc_compute" type="pointcloud_process_v0.py" name="compute_lidar"
    required="true" output="screen">

    <remap from="~pointcloud" to="/lidar_cloud/map"/>

    <rosparam subst_value="True">
      activate: true
      use_gpu:  true
      debug:    false

      invert_yz: false

      link: "base_link"
      #transfo_link: [[1.0,0.0,0.0],[0.0,0.0,1.0],[0.0,-1.0,0.0],]
      transfo_link: [[1.0,0.0,0.0],[0.0,1.0,0.0],[0.0,0.0,1.0],]

      
      reduce_pointcloud_ratio: 1.0
      

      lidar_range_min: 0.0
      lidar_range_max: 100.0
      lidar_z_min: -2.0

      octo_npoints_max: 2000
      octo_depth_max: 100
      octo_padding_size: 0.1

      ground_segmentation_a: -0.6
      ground_segmentation_b: 0.03

      density_max_a: -100
      density_max_b: 0.0
      density_kernel_size: 0.1


      vine_foot_to_plane_trhld: 0.2
      final_vine_selection_a: -0.5
      final_vine_selection_b: 0.0

      ground_approx_error: 0.25
      final_merging_distance: 0.1


    </rosparam>
  </node> 


  <node name="bag_play" pkg="rosbag" type="play" required="true" args="-l -r 1 $(arg bag)" output="log"/>
  <node type="rviz" name="rviz" pkg="rviz" args="-d $(find big_pc_compute)/viz/camz_v1.rviz" />

</launch>
